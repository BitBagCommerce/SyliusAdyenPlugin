{% set factoryName = constant('BitBag\\SyliusAdyenPlugin\\AdyenGatewayFactory::FACTORY_NAME') %}

<div class="ui segment">
    <div class="ui dividing header">{{ 'sylius.ui.payment'|trans }} #{{ loop.index }}</div>
    <div class="ui fluid stackable items">
        {{ form_errors(form.method) }}

        {% for key, choice_form in form.method %}
            {% if form.method.vars.choices[key].data.gatewayConfig.factoryName == factoryName %}
                {% include '@BitBagSyliusAdyenPlugin/Shop/_payment_choose.html.twig' with {
                    'form': choice_form,
                    'method': form.method.vars.choices[key].data,
                    'available_methods': form.channels[choice_form.vars.value]
                } %}
            {% else %}
                {% include '@SyliusShop/Checkout/SelectPayment/_choice.html.twig' with {
                    'form': choice_form,
                    'method': form.method.vars.choices[key].data
                } %}
            {% endif %}
        {% else %}
            {% include '@SyliusShop/Checkout/SelectPayment/_unavailable.html.twig' %}
        {% endfor %}
    </div>

    <script>

        let $form = document.querySelector('form[name=sylius_checkout_select_payment]');
        let $paymentMethods = $form.querySelectorAll(' input[type=radio]');
        let $adyenLayers = $form.querySelectorAll('.adyen-method-grid');

        let showAdyenGrid = (code) => {
            let adyenMethod = $form.querySelector('[data-code='+code+']');
            if(adyenMethod) {
                adyenMethod.querySelector('.adyen-method-grid').style.display = '';
            }
        }

        let hideAdyen = () => {
            $adyenLayers.forEach((adyenLayer) => {
                adyenLayer.style.display = 'none';
            });
        }

        $paymentMethods.forEach(($paymentMethod) => {
            $paymentMethod.addEventListener('change', (e) => {
                hideAdyen();
                showAdyenGrid(e.currentTarget.value);
            });
        });

        let init = () => {
            hideAdyen();
            $paymentMethods.forEach(($paymentMethod) => {
                if($paymentMethod.checked){
                    showAdyenGrid($paymentMethod.value);
                }
            })
        }

        init();
    </script>

    <style>
        .adyen-method-grid {
            display: flex;
            flex-wrap: wrap;
        }

        .adyen-method-grid button[type=submit]
        {
            border: 2px solid rgba(34, 36, 38, 0.15);
            background: transparent;
            padding: 0.2em;
            margin: 0.5em;
            cursor: pointer;
        }
        .adyen-method-grid button[type=submit]:hover
        {
            border-color: #AAAAAA;
        }

        .adyen-method-grid button[type=submit] img
        {
            display: block;
        }
    </style>
</div>
